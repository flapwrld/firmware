# Руководство по прошивке ESP32

## Быстрая прошивка

### 1. Подключение устройства
Подключите ESP32 к компьютеру через USB кабель.

### 2. Проверка порта
```bash
pio device list
```

Найдите порт с описанием "USB-SERIAL CH340" или похожим (например, COM5 на Windows).

### 3. Прошивка
```bash
pio run --target upload --upload-port COM5
```

Замените COM5 на ваш порт.

## Решение проблем

### Ошибка "Wrong boot mode detected"

**Проблема:** ESP32 не в режиме загрузки.

**Решение:**
1. Зажмите кнопку BOOT на ESP32
2. Нажмите кнопку RESET (не отпуская BOOT)
3. Отпустите RESET
4. Отпустите BOOT
5. Запустите команду прошивки снова

### Ошибка "Permission denied" или "Отказано в доступе"

**Проблема:** Порт занят другой программой.

**Решение:**
1. Закройте все программы, использующие порт (Arduino IDE, Serial Monitor и т.д.)
2. Отключите и подключите USB кабель
3. Попробуйте снова

### Ошибка "Failed to connect"

**Проблема:** Не удается подключиться к ESP32.

**Решение:**
1. Проверьте USB кабель (должен поддерживать передачу данных)
2. Проверьте драйвер CH340/CP2102
3. Попробуйте другой USB порт
4. Перезагрузите компьютер

## Мониторинг Serial

Для просмотра отладочных сообщений:

```bash
pio device monitor --port COM5 --baud 115200
```

Выход: Ctrl+C

## Автоматическая прошивка

Для автоматической прошивки без указания порта:

```bash
pio run --target upload
```

PlatformIO автоматически найдет подключенный ESP32.

## Полная очистка и прошивка

Для полной очистки флеш-памяти перед прошивкой:

```bash
pio run --target erase
pio run --target upload
```

## Проверка прошивки

После успешной прошивки вы должны увидеть:

```
Writing at 0x00010000... (100 %)
Hash of data verified.
Leaving...
Hard resetting via RTS pin...
[SUCCESS]
```

Устройство автоматически перезагрузится и запустит новую прошивку.

## Первый запуск

После прошивки:
1. ESP32 автоматически перезагрузится
2. На дисплее появится стартовый экран с логотипом "HAKLES"
3. Прогресс-бар заполнится за 2 секунды
4. Нажмите кнопку OK для входа в меню

## Отладка

Для просмотра отладочных сообщений в реальном времени:

```bash
pio device monitor --port COM5 --baud 115200 --filter esp32_exception_decoder
```

Фильтр `esp32_exception_decoder` автоматически декодирует stack traces.

## Сборка без прошивки

Для проверки компиляции без загрузки на устройство:

```bash
pio run
```

## Информация о прошивке

После сборки вы увидите:
- RAM: ~9% (29KB из 327KB)
- Flash: ~32% (423KB из 1310KB)

## Скрипты для быстрой прошивки

### Windows (flash.bat)
```batch
@echo off
pio run --target upload --upload-port COM5
pause
```

### Linux/macOS (flash.sh)
```bash
#!/bin/bash
pio run --target upload --upload-port /dev/ttyUSB0
```

Сделайте скрипт исполняемым:
```bash
chmod +x flash.sh
./flash.sh
```

## Частые вопросы

**Q: Как узнать версию прошивки?**
A: Версия отображается в Serial Monitor при загрузке.

**Q: Можно ли прошить через WiFi?**
A: Да, используйте OTA (Over-The-Air) обновление (требует настройки).

**Q: Сколько времени занимает прошивка?**
A: Обычно 15-20 секунд.

**Q: Нужно ли устанавливать драйверы?**
A: Для CH340 чипа может потребоваться установка драйвера на Windows.

## Успешная прошивка

Вы успешно прошили ESP32, если:
- ✅ Процесс завершился с [SUCCESS]
- ✅ Устройство перезагрузилось
- ✅ На дисплее появился стартовый экран
- ✅ Кнопки реагируют на нажатия

Наслаждайтесь новым интерфейсом HAKLES!
